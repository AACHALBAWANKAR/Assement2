create table customers(customer_id int,
customer_name varchar,
city varchar
)

create table orders(order_id int primary key,
customer_id int,
order_date date,
total_amount int,
status varchar
)

create table payments(payment_id int Primary key,
order_id int,
payment_date date, 
payment_amount int
)

1.Find orders where payment was done before the order date. 
 select
    o.order_id, 
    o.customer_id, 
    o.order_date, 
    p.payment_date
from orders o
join payments p on o.order_id = p.order_id
where p.payment_date < o.order_date;

2.Show orders that have the same total_amount but belong to different customers. 
select
    o1.order_id AS order1_id,
    o1.customer_id AS customer1,
    o2.order_id AS order2_id,
    o2.customer_id AS customer2,
    o1.total_amount
FROM orders o1
JOIN orders o2 
    ON o1.total_amount = o2.total_amount 
   AND o1.customer_id <> o2.customer_id
WHERE o1.order_id < o2.order_id;

3.Show customer name, order date, total amount, and payment amount (include NULL if no payment). 
select
    c.customer_name, 
    o.order_date, 
    o.total_amount, 
    p.payment_amount
FROM customers c
JOIN orders o ON c.customer_id = o.customer_id
LEFT JOIN payments p ON o.order_id = p.order_id;

4.Show customers who made payment but order was cancelled. 
select 
    c.customer_name, 
    o.order_id, 
    o.status, 
    p.payment_id, 
    p.payment_amount
FROM customers c
JOIN orders o ON c.customer_id = o.customer_id
JOIN payments p ON o.order_id = p.order_id
WHERE o.status = 'Cancelled';

5.Find customers who spent more than the average of all customers. 
select 
    c.customer_name, 
    sum(o.total_amount) as total_spent
from customers c
join orders o on c.customer_id = o.customer_id
where o.status = 'Delivered'
group by c.customer_name
having by (o.total_amount) > (
    select avg (total_spent)
    from (
        select sum(total_amount) as total_spent
        from orders
        where status = 'Delivered'
        group by customer_id
    ) as avg_table
);

6. Find customers whose total spending is greater than Riya Sharmaâ€™s spending. 
select
c.customer_name, 
sum(o.total_amount) as total_spent
from customers c
join orders o ON c.customer_id = o.customer_id
where o.status = 'Delivered'
group by c.customer_name
having by (o.total_amount) > (select sum(o2.total_amount)
from customers c2
join orders o2 on c2.customer_id = o2.customer_id
where c2.customer_name = 'Riya Sharma'
and o2.status = 'Delivered'
);

7.Show difference between each order and previous order of same customer. 
 select
    customer_id, 
    order_id, 
    order_date, 
    total_amount,
    total_amount - LAG(total_amount) OVER (PARTITION BY customer_id ORDER BY order_date) AS difference_from_previous
from orders;

8. Show next order date for each customer. 
select
    customer_id, 
    order_id, 
    order_date, 
    LEAD(order_date) OVER (PARTITION BY customer_id ORDER BY order_date) AS next_order_date
from orders;

9. Rank customers within city by total amount. 
select
    c.city, 
    c.customer_name, 
    sum(o.total_amount) AS total_spent,
    RANK() OVER (PARTITION BY c.city ORDER BY SUM(o.total_amount) DESC) AS city_rank
from customers c
join orders o on c.customer_id = o.customer_id
where o.status = 'Delivered'
group by c.city, c.customer_name;

10. Find biggest drop in amount between 2 consecutive orders (per customer).  
select
    customer_id, 
    order_id, 
    order_date,
    total_amount - LAG(total_amount) OVER (PARTITION BY customer_id ORDER BY order_date) AS difference
from orders
ORDER BY customer_id, order_date;








